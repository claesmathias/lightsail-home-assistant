#!/bin/bash
# install the necessary tools
sudo yum install docker git unzip -y

# add new group and add ec2 user
sudo groupadd docker
sudo usermod -aG docker ec2-user

# enable docker at startup
sudo systemctl enable docker.service
sudo systemctl start docker.service

# install docker-compose
sudo curl -L "https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# clone
cd /home/ec2-user/
git clone https://github.com/claesmathias/lightsail-home-assistant.git

# set docker-compose environment variables
cat <<EOF >/home/ec2-user/lightsail-home-assistant/.env
EMAIL=mail@example.com
URL=example.com
SUBDOMAINS=www
EXTRA_DOMAINS=
DUCKDNS_SUBDOMAINS=subdomain.duckdns.org
DUCKDNS_TOKEN=duck-dns-token
TZ=Europe/Brussels
EXTERNAL_URL=https://example.com
SPOTIFY_CLIENT_ID=
SPOTIFY_CLIENT_SECRET=
EOF

# install Home Assistant Community Store (HACS)
wget "https://github.com/hacs/integration/releases/latest/download/hacs.zip" -P /home/ec2-user/lightsail-home-assistant
mkdir -p /home/ec2-user/home-assistant/custom_components
unzip /home/ec2-user/lightsail-home-assistant/hacs.zip -d /home/ec2-user/home-assistant/custom_components/hacs

# download Amazoon Root CA for AWS IoT Core MQTT communication for things
wget https://www.amazontrust.com/repository/AmazonRootCA1.pem -P /home/ec2-user/home-assistant/
cp /home/ec2-user/lightsail-home-assistant/configuration.yaml /home/ec2-user/home-assistant/

# aws cli
#alias aws='docker run --rm -it amazon/aws-cli'

# set permissions
sudo chown -R ec2-user:ec2-user /home/ec2-user/lightsail-home-assistant/
sudo chown -R ec2-user:ec2-user /home/ec2-user/home-assistant

# set selinux permissions
sudo chcon -Rt svirt_sandbox_file_t /home/ec2-user

# start docker containers
cd /home/ec2-user/lightsail-home-assistant/
/usr/local/bin/docker-compose up -d

# reset ssh permissions
restorecon -FRvv ~/.ssh
